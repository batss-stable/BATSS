<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parallel computation • BATSS</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Parallel computation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">BATSS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9005</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><h6 class="dropdown-header" data-toc-skip>Main topics</h6></li>
    <li><a class="dropdown-item" href="../../articles/web_only/Ingredients.html">BATSS Ingredients</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/Priors.html">Prior distributions</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/parallelisation.html">Parallel and cluster computation</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Examples</h6></li>
    <li><a class="dropdown-item" href="../../articles/web_only/ancova.html">ANCOVA</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/negbin.html">Negative binomial endpoint</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/binomial.html">Binomial endpoint</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Parallel computation</h1>
            
      

      <div class="d-none name"><code>parallelisation.Rmd</code></div>
    </div>

    
    
<p>To speed up computation, the <code>batss.glm</code> function can use
parallelisation on a single machine by setting
<code>computation = "parallel"</code> (the default; see the help of
<code>batss.glm</code> for details).</p>
<p>When using multiple machines and/or a cluster, parallelisation can be
achieved by splitting the set of seeds - corresponding to as many
simulated trials - between machines or cluster CPUs, saving the
<code>batss.glm</code> outputs, and merging them using the function
<code>batss.combine</code>.</p>
<p>We describe here how to use the functions <code>batss.glm</code> and
<code>batss.combine</code> in two settings when:</p>
<ul>
<li>using several machines,</li>
<li>using a cluster.</li>
</ul>
<div class="section level2">
<h2 id="several-machines">Several machines<a class="anchor" aria-label="anchor" href="#several-machines"></a>
</h2>
<p>Let’s assume a <strong>BATSS</strong> user wants to perform a Monte
Carlo simulation considering 10,000 trials and has two computers, each
of them with 10 CPUs.</p>
<p>The strategy we suggest consists of</p>
<ul>
<li>running <code>batss.glm</code> on each each computer for a different
subset of 5,000 seeds among the 10,000 seeds of interest specified in
the argument <code>R</code> (so that each computer evaluates a different
set of seeds), with
<ul>
<li>argument <code>computation</code> set to <code>parallel</code> and
the argument <code>mc.cores</code> set to <code>10</code> (or
<code><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">parallel::detectCores()</a></code>), the number of CPUs of the
computer of interest,</li>
<li>argument <code>extended</code> set to <code>1</code> or
<code>2</code> (check <code><a href="../../reference/batss.glm.html">?batss.glm</a></code> for details),</li>
</ul>
</li>
<li>saving the <code>batss.glm</code> output as RData files with the
function <code>save</code> under a name specific to the task of each
computer (such as the first or last seed evaluated by each
computer),</li>
<li>finally, using the function <code>batss.combine</code> to combine
these outputs.</li>
</ul>
<p>Let’s have the first computer run seeds 1 to 5,000 and save the
output under <code>seed1to5000.rdata</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://batss-stable.github.io/BATSS/" class="external-link">BATSS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">##</span></span>
<span><span class="co">## run seeds 1 to 5000 (example of batss.glm)</span></span>
<span><span class="co">##</span></span>
<span></span>
<span><span class="va">seed1to5000</span> <span class="op">=</span> <span class="fu"><a href="../../reference/batss.glm.html">batss.glm</a></span><span class="op">(</span></span>
<span>                model            <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">group</span>,   </span>
<span>                var              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y     <span class="op">=</span> <span class="va">rnorm</span>,</span>
<span>                                        group <span class="op">=</span> <span class="va">alloc.balanced</span><span class="op">)</span>,</span>
<span>                var.control      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                beta             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                which            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                alternative      <span class="op">=</span> <span class="st">"greater"</span>,</span>
<span>                R                <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5000</span>,</span>
<span>                N                <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                interim          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>recruited <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">180</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                prob0            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>C <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, T1 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, T2 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                eff.arm          <span class="op">=</span> <span class="va">eff.arm.simple</span>,</span>
<span>                eff.arm.control  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>                fut.arm          <span class="op">=</span> <span class="va">fut.arm.simple</span>,</span>
<span>                fut.arm.control  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>                computation      <span class="op">=</span> <span class="st">"parallel"</span>,</span>
<span>                H0               <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                mc.cores         <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                extended         <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##</span></span>
<span><span class="co">## save results as an rdata file</span></span>
<span><span class="co">##</span></span>
<span></span>
<span><span class="co"># specify here the folder in which to save the output</span></span>
<span><span class="va">path_computer1</span> <span class="op">=</span> <span class="st">"~/"</span></span>
<span><span class="co"># save</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">seed1to5000</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_computer1</span>,<span class="st">"seed1to5000.rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s now have the second computer run seeds 5,001 to 10,000 and save
the output under <code>seed1to5000.rdata</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##</span></span>
<span><span class="co">## run seeds 5001 to 10000 (example of batss.glm)</span></span>
<span><span class="co">##</span></span>
<span></span>
<span><span class="va">seed5001to10000</span> <span class="op">=</span> <span class="fu"><a href="../../reference/batss.glm.html">batss.glm</a></span><span class="op">(</span></span>
<span>                model            <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">group</span>,   </span>
<span>                var              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y     <span class="op">=</span> <span class="va">rnorm</span>,</span>
<span>                                        group <span class="op">=</span> <span class="va">alloc.balanced</span><span class="op">)</span>,</span>
<span>                var.control      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                beta             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                which            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                alternative      <span class="op">=</span> <span class="st">"greater"</span>,</span>
<span>                R                <span class="op">=</span> <span class="fl">5001</span><span class="op">:</span><span class="fl">10000</span>,</span>
<span>                N                <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                interim          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>recruited <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">180</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                prob0            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>C <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, T1 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, T2 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>                eff.arm          <span class="op">=</span> <span class="va">eff.arm.simple</span>,</span>
<span>                eff.arm.control  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>                fut.arm          <span class="op">=</span> <span class="va">fut.arm.simple</span>,</span>
<span>                fut.arm.control  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>                computation      <span class="op">=</span> <span class="st">"parallel"</span>,</span>
<span>                H0               <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                mc.cores         <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                extended         <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##</span></span>
<span><span class="co">## save results as an rdata file</span></span>
<span><span class="co">##</span></span>
<span></span>
<span><span class="co"># specify here the folder in which to save the output</span></span>
<span><span class="va">path_computer2</span> <span class="op">=</span> <span class="st">"~/"</span></span>
<span><span class="co"># save</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">seed5001to10000</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_computer2</span>,<span class="st">"seed5001to10000.rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Transfer the objects <code>seed1to5000.rdata</code> and
<code>seed5001to10000.rdata</code> to the same folder of the same
computer, for example <code>path_computer1</code> above, and merge the
objects with the function <code>batss.combine</code> as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine</span></span>
<span><span class="va">seed1to10000</span> <span class="op">=</span> <span class="fu"><a href="../../reference/batss.combine.html">batss.combine</a></span><span class="op">(</span></span>
<span>    paths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_computer1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"seed1to5000"</span>,<span class="st">"seed5001to10000"</span><span class="op">)</span>,<span class="st">".rdata"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># look at combined results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">seed1to10000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cluster">Cluster<a class="anchor" aria-label="anchor" href="#cluster"></a>
</h2>
<p>Let’s assume a <strong>BATSS</strong> user wants to perform a Monte
Carlo simulation considering 10,000 trials and has access to 500 CPUs of
a cluster.</p>
<p>The strategy we suggest consists of</p>
<ul>
<li>running <code>batss.glm</code> on each CPU for a specific subset of
the 10,000 seeds of interest specified in the argument <code>R</code>
(so that each CPU evaluates a different set of seeds), with argument
<code>computation</code> set to <code>sequential</code> (as
parallelisation is already achieved by the large number of CPUs),</li>
<li>saving each CPU’s <code>batss.glm</code> output as an RData file
using the function <code>save</code> with filenames indicating the task
(e.g., based on the first or last seed evaluated by each CPU),</li>
<li>using the <code>batss.combine</code> function to merge all these
outputs into a single one.</li>
</ul>
<p>There are multiple ways to accomplish this. In the following, we
describe the approach we follow. Let us assume that</p>
<ul>
<li>the cluster runs a <strong>Linux OS</strong> with
<strong>Slurm</strong> as workload manager (a common setup in cluster
computing),</li>
<li>the working directory for this simulation is
<code>~/batss-example/</code>, which contains:
<ul>
<li>a folder <code>~/batss-example/in/</code> with (optional) inputs,
like parameters values saved in RData format, or an R script containing
user-defined functions to be used by <code>batss.glm</code> (like the
function <code>treatalloc.fun</code> described in the ANCOVA help page)
that is to be sourced by each CPU,</li>
<li>a folder <code>~/batss-example/out/</code> where all outputs from
the CPUs will be stored,</li>
<li>an R script <code>~/batss-example/1-run.r</code>, which
<ul>
<li>optionally loads and sources elements of the folder
<code>~/batss-example/in/</code>,</li>
<li>runs the <code>batss.glm</code> function for a set of seeds assigned
by <strong>Slurm</strong>,</li>
<li>saves the output in folder <code>~/batss-example/out/</code>
folder,</li>
</ul>
</li>
<li>an R script <code>~/batss-example/2-combine.r</code>, which merges
the different 500 <code>batss.glm</code> outputs with the function
<code>batss.combine</code>,</li>
<li>a shell script <code>~/batss-example/batss_sim.sh</code> containing
the instructions for each CPU.</li>
</ul>
</li>
</ul>
<p>The simulation is conducted by:</p>
<ul>
<li>i/ invoking the <code>sbatch</code> command, which</li>
<li>ii/ runs the shell script <code>~/batss-example/batss_sim.sh</code>
on each CPU, which</li>
<li>iii/ starts R and executes the <code>~/batss-example/1-run.r</code>
script that performs the parallelised simulation,</li>
<li>iv/ and finally executing the
<code>~/batss-example/2-combine.r</code> script that merges all
simulation results.</li>
</ul>
<p>Let’s describe each step:</p>
<div class="section level3">
<h3 id="sbatch-command">sbatch command<a class="anchor" aria-label="anchor" href="#sbatch-command"></a>
</h3>
<p>The following command corresponds to the <strong>Slurm</strong>
<code>sbatch</code> submission command. It submits a job array with task
IDs from 1 to 500 (i.e., the number of CPUs), executing the script
sim_batch.sh and passing <code>in</code> (input folder) and
<code>out</code> (output folder) as arguments for each task:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># move to the folder of interest </span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="bu">cd</span> ~/batss-example</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># sbatch function</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--array</span><span class="op">=</span>1-500 batss_sim.sh in out</span></code></pre></div>
<p>For additional options such as setting the maximum computation time,
memory limits, or email notifications, please refer to the help section
of the sbatch command or consult your cluster’s documentation.</p>
</div>
<div class="section level3">
<h3 id="batss_sim-sh-shell-script">batss_sim.sh shell script<a class="anchor" aria-label="anchor" href="#batss_sim-sh-shell-script"></a>
</h3>
<p>The following command of the shell script fed into the
<code>sbatch</code> call above tells each CPU to start <code>R</code>
(both in <code>slave</code> and <code>vanilla</code> mode), run the
script <code>1-run.r</code> with</p>
<ul>
<li>arguments <code>$1</code> and <code>$2</code>, corresponding
respectively to the <code>in</code> and <code>out</code> folders
specified at the end of the call to <code>sbatch</code>,</li>
<li>the location where to save the <code>Rout</code> files related to
each task (i.e., CPU job here referred to
as<code>$SLURM_ARRAY_TASK_ID</code> and provided by
<strong>Slurm</strong>): these files will be saved in the
<code>out</code> folder (indicated as <code>$2</code>).</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">R</span> <span class="at">--slave</span> <span class="at">--vanilla</span> <span class="op">&lt;</span> 1-run.r <span class="at">--args</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$1</span> <span class="va">$2</span> <span class="op">&gt;</span> <span class="va">$2</span>/<span class="va">${SLURM_ARRAY_TASK_ID}</span>.Rout <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code></pre></div>
<p>Note that the R program may not be directly available via a call to R
and that you might need to</p>
<ul>
<li>specify the full path to R,</li>
<li>add to the shell script a way to make R available (like the
<code>module</code> command, for example)</li>
</ul>
<p>You can check this with your cluster manager.</p>
</div>
<div class="section level3">
<h3 id="run-r-r-script">1-run.r R script<a class="anchor" aria-label="anchor" href="#run-r-r-script"></a>
</h3>
<p>The following code shows the content of the R script run by each CPU.
The code</p>
<ul>
<li>loads the library <strong>BATSS</strong>,</li>
<li>defines the vector of seeds related to the job ID attributed by
<strong>Slurm</strong>,</li>
<li>runs the batss.glm for that vector of seeds with
<code>computation</code> set to <code>sequential</code> and
<code>extended</code> set to 1,</li>
<li>saves the results in the output folder under of name that
corresponds to the first seed.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###################################</span></span>
<span><span class="co">## setup </span></span>
<span><span class="co">###################################</span></span>
<span></span>
<span></span>
<span><span class="co"># load library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://batss-stable.github.io/BATSS/" class="external-link">BATSS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define list of seed for CPU to handle where</span></span>
<span><span class="co"># - args[1] is the job id attributed by slurm </span></span>
<span><span class="co">#   that we will use as first seed</span></span>
<span><span class="co"># - 10000 is the number of simulations (i.e., seeds)</span></span>
<span><span class="co"># - 500 is the number of CPUs</span></span>
<span><span class="va">seed.list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,<span class="fl">10000</span>,<span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define path to in/ and out/ folders (input of sbatch)</span></span>
<span><span class="va">path_in</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="st">"/"</span><span class="op">)</span></span>
<span><span class="va">path_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,<span class="st">"/"</span><span class="op">)</span></span>
<span><span class="co"># optionally load/source info from relevant files </span></span>
<span><span class="co"># of "in/" here</span></span>
<span></span>
<span></span>
<span><span class="co">###################################</span></span>
<span><span class="co">## simulation </span></span>
<span><span class="co">###################################</span></span>
<span></span>
<span><span class="co"># only compute res if needed</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">path_out</span><span class="op">)</span><span class="op">==</span><span class="va">id.seed</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">##</span></span>
<span>    <span class="co">## batss.glm</span></span>
<span>    <span class="co">##</span></span>
<span>    <span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>                        </span>
<span>    <span class="va">sim</span>   <span class="op">=</span> <span class="fu"><a href="../../reference/batss.glm.html">batss.glm</a></span><span class="op">(</span></span>
<span>            model            <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">group</span>,   </span>
<span>            var              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y     <span class="op">=</span> <span class="va">rnorm</span>,</span>
<span>                                    group <span class="op">=</span> <span class="va">alloc.balanced</span><span class="op">)</span>,</span>
<span>            var.control      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            beta             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>            which            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>            alternative      <span class="op">=</span> <span class="st">"greater"</span>,</span>
<span>            R                <span class="op">=</span> <span class="va">seed.list</span>,</span>
<span>            N                <span class="op">=</span> <span class="fl">200</span>,</span>
<span>            interim          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>recruited <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">180</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            prob0            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>C <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, T1 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, T2 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>            eff.arm          <span class="op">=</span> <span class="va">eff.arm.simple</span>,</span>
<span>            eff.arm.control  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>            fut.arm          <span class="op">=</span> <span class="va">fut.arm.simple</span>,</span>
<span>            fut.arm.control  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>            computation      <span class="op">=</span> <span class="st">"sequential"</span>,</span>
<span>            H0               <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            extended         <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">finish</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">## print required time</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\trequired time: "</span>,<span class="va">finish</span><span class="op">-</span><span class="va">start</span>,<span class="st">"\n\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">## store results</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">sim</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_out</span>,<span class="va">seed.list</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="st">".rdata"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="co"># end if</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n\t"</span>,<span class="fu"><a href="https://rdrr.io/r/base/date.html" class="external-link">date</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n\t DONE!\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/quit.html" class="external-link">q</a></span><span class="op">(</span><span class="st">"no"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combine-r-r-script">2-combine.r R script<a class="anchor" aria-label="anchor" href="#combine-r-r-script"></a>
</h3>
<p>Once the simulation is complete, the following code merges all
results into a single object:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://batss-stable.github.io/BATSS/" class="external-link">BATSS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define list of 'successful' jobs</span></span>
<span><span class="va">job.list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="st">"out/"</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Rout"</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="st">"out/"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># list of potential 'unsuccessful' slurm jobs to be </span></span>
<span><span class="co"># investigated by looking at the corresponding </span></span>
<span><span class="co"># 'out' (slurm) and 'Rout' (R) files</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">500</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">500</span><span class="op">)</span>,<span class="st">".rdata"</span><span class="op">)</span>,<span class="va">job.list</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># merge</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="../../reference/batss.combine.html">batss.combine</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"out/"</span>,<span class="va">job.list</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># store results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">sim</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"out/full.rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dominique-Laurent Couturier, Liz Ryan, Rainer Puhr, Thomas Jaki, Stephane Heritier.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
